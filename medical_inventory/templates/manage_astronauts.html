{% extends 'base.html' %}
{% load static %}

{% block title %}Manage Astronauts - NASA Medical Inventory{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/admin-pages.css' %}">
{% endblock %}

{% block content %}
<div class="container">
    <div class="page-header">
        <h1>Manage Astronauts</h1>
        <p>Add astronauts and register their facial data</p>
    </div>
    {% comment %} .container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
    }

    .header {
        text-align: center;
        margin-bottom: 40px;
    }

    .header h1 {
        font-size: 2.5rem;
        margin-bottom: 10px;
    }

    .add-section {
        background: rgba(255, 255, 255, 0.05);
        border-radius: 12px;
        padding: 30px;
        margin-bottom: 30px;
        border: 1px solid rgba(252, 61, 33, 0.3);
    }

    .add-section h2 {
        color: #FC3D21;
        margin-bottom: 20px;
        font-size: 1.5rem;
    }

    .form-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin-bottom: 20px;
    }

    .form-group {
        display: flex;
        flex-direction: column;
    }

    label {
        margin-bottom: 8px;
        color: rgba(255, 255, 255, 0.8);
        font-weight: 500;
    }

    input[type="text"],
    input[type="email"],
    input[type="password"] {
        padding: 12px;
        border-radius: 8px;
        border: 1px solid rgba(255, 255, 255, 0.2);
        background: rgba(255, 255, 255, 0.05);
        color: white;
        font-size: 1rem;
    }

    input[type="file"] {
        padding: 10px;
        border-radius: 8px;
        border: 1px solid rgba(255, 255, 255, 0.2);
        background: rgba(255, 255, 255, 0.05);
        color: white;
        cursor: pointer;
    }

    .file-preview {
        margin-top: 15px;
        text-align: center;
    }

    .file-preview img {
        max-width: 200px;
        max-height: 200px;
        border-radius: 8px;
        border: 2px solid rgba(252, 61, 33, 0.5);
    }

    .file-info {
        margin-top: 10px;
        color: rgba(255, 255, 255, 0.6);
        font-size: 0.9rem;
    }

    .btn {
        padding: 12px 24px;
        border-radius: 8px;
        border: none;
        font-size: 1rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s;
    }

    .btn-primary {
        background: #FC3D21;
        color: white;
    }

    .btn-primary:hover {
        background: #d93419;
    }

    .btn-secondary {
        background: rgba(255, 255, 255, 0.1);
        color: white;
        border: 1px solid rgba(255, 255, 255, 0.3);
    }

    .astronaut-list {
        background: rgba(255, 255, 255, 0.03);
        border-radius: 12px;
        padding: 30px;
        border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .astronaut-list h2 {
        color: #FC3D21;
        margin-bottom: 20px;
    }

    .astronaut-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
        gap: 20px;
    }

    .astronaut-card {
        background: rgba(255, 255, 255, 0.05);
        border-radius: 10px;
        padding: 20px;
        border: 1px solid rgba(255, 255, 255, 0.1);
        transition: all 0.3s;
    }

    .astronaut-card:hover {
        border-color: rgba(252, 61, 33, 0.5);
        transform: translateY(-2px);
    }

    .astronaut-photo {
        width: 100px;
        height: 100px;
        border-radius: 50%;
        margin: 0 auto 15px;
        display: block;
        object-fit: cover;
        border: 3px solid rgba(252, 61, 33, 0.5);
        background: rgba(255, 255, 255, 0.1);
    }

    .astronaut-info {
        text-align: center;
    }

    .astronaut-name {
        font-size: 1.2rem;
        font-weight: bold;
        margin-bottom: 5px;
    }

    .astronaut-id {
        color: #FFC107;
        margin-bottom: 10px;
    }

    .face-status {
        display: inline-block;
        padding: 4px 12px;
        border-radius: 5px;
        font-size: 0.85rem;
        margin-top: 10px;
    }

    .face-status.encoded {
        background: #4CAF50;
    }

    .face-status.no-encoding {
        background: #F44336;
    }

    .card-actions {
        display: flex;
        gap: 10px;
        margin-top: 15px;
    }

    .card-actions button {
        flex: 1;
        padding: 8px;
        font-size: 0.9rem;
    }

    .alert {
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 20px;
        display: none;
    }

    .alert.show {
        display: block;
    }

    .alert.success {
        background: rgba(76, 175, 80, 0.2);
        border: 1px solid #4CAF50;
        color: #4CAF50;
    }
 {% endcomment %}


    <div id="alertBox" class="alert"></div>

    <div class="add-section">
        <h2>Add New Astronaut</h2>
        <form id="astronautForm" enctype="multipart/form-data">
            {% csrf_token %}
            <div class="form-grid">
                <div class="form-group">
                    <label for="name">Full Name *</label>
                    <input type="text" id="name" name="name" required>
                </div>

                <div class="form-group">
                    <label for="astronaut_id">Astronaut ID *</label>
                    <input type="text" id="astronaut_id" name="astronaut_id" placeholder="NASA001" required>
                </div>

                <div class="form-group">
                    <label for="email">Email</label>
                    <input type="email" id="email" name="email" placeholder="astronaut@nasa.gov">
                </div>

                <div class="form-group">
                    <label for="password">Password (for admin access)</label>
                    <input type="password" id="password" name="password">
                </div>
            </div>

            <div class="form-group">
                <label for="photo">Face Photo (for recognition) *</label>
                <input type="file" id="photo" name="photo" accept="image/*" required>
                <p style="color: rgba(255, 255, 255, 0.5); font-size: 0.85rem; margin-top: 5px;">
                    ðŸ“¸ Clear, front-facing photo with good lighting. Face should be clearly visible.
                </p>
                <div id="photoPreview" class="file-preview"></div>
            </div>

            <button type="submit" class="btn btn-primary">âž• Add Astronaut</button>
        </form>
    </div>

    <div class="astronaut-list">
        <h2>All Astronauts</h2>
        <div class="astronaut-grid" id="astronautGrid">
            <!-- Will be populated by JavaScript -->
        </div>
    </div>
</div>
{% endblock %}

{% block extra_script %}
<script>
    // Preview photo before upload
    document.getElementById('photo').addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                const preview = document.getElementById('photoPreview');
                preview.innerHTML = `
                    <img src="${e.target.result}" alt="Preview">
                    <div class="file-info">${file.name} (${(file.size / 1024).toFixed(1)} KB)</div>
                `;
            };
            reader.readAsDataURL(file);
        }
    });

    // Submit form
    document.getElementById('astronautForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const formData = new FormData(this);
        
        try {
            const response = await fetch('/api/astronauts/add/', {
                method: 'POST',
                body: formData
            });

            const data = await response.json();

            if (data.success) {
                showAlert('âœ“ Astronaut added successfully! Face encoding registered.', 'success');
                this.reset();
                document.getElementById('photoPreview').innerHTML = '';
                loadAstronauts();
            } else {
                showAlert('âœ— Error: ' + (data.message || 'Failed to add astronaut'), 'error');
            }
        } catch (error) {
            showAlert('âœ— Connection error: ' + error.message, 'error');
        }
    });

    // Load astronauts
    async function loadAstronauts() {
        try {
            const response = await fetch('/api/astronauts/list/');
            const data = await response.json();

            const grid = document.getElementById('astronautGrid');
            
            if (data.astronauts && data.astronauts.length > 0) {
                grid.innerHTML = data.astronauts.map(astronaut => `
                    <div class="astronaut-card">
                        <img src="${astronaut.photo_url || '/static/default-avatar.png'}" 
                             alt="${astronaut.name}" 
                             class="astronaut-photo"
                             onerror="this.src='/static/default-avatar.png'">
                        <div class="astronaut-info">
                            <div class="astronaut-name">${astronaut.name}</div>
                            <div class="astronaut-id">${astronaut.astronaut_id}</div>
                            <span class="face-status ${astronaut.has_face_encoding ? 'encoded' : 'no-encoding'}">
                                ${astronaut.has_face_encoding ? 'âœ“ Face Encoded' : 'âœ— No Encoding'}
                            </span>
                            <div class="card-actions">
                                ${!astronaut.has_face_encoding ? 
                                    `<button class="btn btn-secondary" onclick="updateFace(${astronaut.id})">Add Face</button>` : 
                                    `<button class="btn btn-secondary" onclick="updateFace(${astronaut.id})">Update Face</button>`
                                }
                                <button class="btn btn-secondary" onclick="deleteAstronaut(${astronaut.id})">Delete</button>
                            </div>
                        </div>
                    </div>
                `).join('');
            } else {
                grid.innerHTML = '<p style="color: rgba(255, 255, 255, 0.5); text-align: center;">No astronauts added yet.</p>';
            }
        } catch (error) {
            console.error('Error loading astronauts:', error);
        }
    }

    function updateFace(astronautId) {
        const input = document.createElement('input');
        input.type = 'file';
        input.accept = 'image/*';
        input.onchange = async function(e) {
            const file = e.target.files[0];
            if (!file) return;

            const formData = new FormData();
            formData.append('photo', file);
            formData.append('astronaut_id', astronautId);

            try {
                const response = await fetch('/api/astronauts/update-face/', {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();

                if (data.success) {
                    showAlert('âœ“ Face encoding updated successfully!', 'success');
                    loadAstronauts();
                } else {
                    showAlert('âœ— Error: ' + (data.message || 'Failed to update face'), 'error');
                }
            } catch (error) {
                showAlert('âœ— Connection error: ' + error.message, 'error');
            }
        };
        input.click();
    }

    async function deleteAstronaut(astronautId) {
        if (!confirm('Are you sure you want to delete this astronaut?')) return;

        try {
            const response = await fetch(`/api/astronauts/delete/${astronautId}/`, {
                method: 'DELETE',
                headers: {
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                }
            });

            const data = await response.json();

            if (data.success) {
                showAlert('âœ“ Astronaut deleted successfully', 'success');
                loadAstronauts();
            } else {
                showAlert('âœ— Error: ' + (data.message || 'Failed to delete'), 'error');
            }
        } catch (error) {
            showAlert('âœ— Connection error: ' + error.message, 'error');
        }
    }

    function showAlert(message, type) {
        const alert = document.getElementById('alertBox');
        alert.textContent = message;
        alert.className = `alert ${type} show`;
        
        setTimeout(() => {
            alert.classList.remove('show');
        }, 5000);
    }

    // Load astronauts on page load
    loadAstronauts();
</script>
{% endblock %}