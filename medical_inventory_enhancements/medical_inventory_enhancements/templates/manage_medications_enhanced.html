{% extends 'base.html' %}
{% load static %}

{% block title %}Manage Medications - NASA Medical Inventory{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/admin-pages.css' %}">
<style>
    .search-export-bar {
        background: rgba(255, 255, 255, 0.05);
        padding: 20px;
        border-radius: 8px;
        margin-bottom: 20px;
        display: flex;
        gap: 15px;
        align-items: center;
        flex-wrap: wrap;
    }
    
    .search-box {
        flex: 1;
        min-width: 250px;
        position: relative;
    }
    
    .search-input {
        width: 100%;
        padding: 12px 40px 12px 12px;
        border-radius: 8px;
        border: 2px solid rgba(252, 61, 33, 0.3);
        background: rgba(0, 0, 0, 0.3);
        color: white;
        font-size: 16px;
    }
    
    .search-input:focus {
        outline: none;
        border-color: #FC3D21;
    }
    
    .search-icon {
        position: absolute;
        right: 12px;
        top: 50%;
        transform: translateY(-50%);
        color: #FC3D21;
    }
    
    .export-csv-btn {
        background: #4CAF50;
        color: white;
        border: none;
        padding: 12px 24px;
        border-radius: 8px;
        cursor: pointer;
        font-weight: 600;
        white-space: nowrap;
        display: flex;
        align-items: center;
        gap: 8px;
    }
    
    .export-csv-btn:hover {
        background: #45a049;
        transform: translateY(-2px);
    }
</style>
{% endblock %}

{% block content %}
<div class="container">
    <div class="page-header">
        <h1>üíä Manage Medications</h1>
        <p>Add medications and upload reference images</p>
    </div>

    <div id="alertBox" class="alert"></div>

    <!-- Search and Export Bar -->
    <div class="search-export-bar">
        <div class="search-box">
            <input type="text" 
                   id="medicationSearch" 
                   class="search-input" 
                   placeholder="üîç Search medications by name, type, or location..."
                   autocomplete="off">
            <span class="search-icon">üîç</span>
        </div>
        <button class="export-csv-btn" onclick="exportToCSV()">
            üìä Export to CSV
        </button>
    </div>

    <div class="add-section">
        <h2>Add New Medication</h2>
        <form id="medicationForm" enctype="multipart/form-data">
            {% csrf_token %}
            <div class="form-grid">
                <div class="form-group">
                    <label for="name">Medication Name *</label>
                    <input type="text" id="name" name="name" required>
                </div>

                <div class="form-group">
                    <label for="generic_name">Generic Name</label>
                    <input type="text" id="generic_name" name="generic_name">
                </div>

                <div class="form-group">
                    <label for="medication_type">Type</label>
                    <select id="medication_type" name="medication_type">
                        <option value="ANALGESIC">Pain Relief</option>
                        <option value="ANTIBIOTIC">Antibiotic</option>
                        <option value="ANTINAUSEA">Anti-Nausea</option>
                        <option value="SLEEP_AID">Sleep Aid</option>
                        <option value="ALLERGY">Allergy</option>
                        <option value="STIMULANT">Stimulant</option>
                        <option value="OTHER">Other</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="dosage">Dosage</label>
                    <input type="text" id="dosage" name="dosage" placeholder="e.g., 500mg">
                </div>

                <div class="form-group">
                    <label for="current_quantity">Current Quantity *</label>
                    <input type="number" id="current_quantity" name="current_quantity" min="0" required>
                </div>

                <div class="form-group">
                    <label for="minimum_quantity">Minimum Quantity *</label>
                    <input type="number" id="minimum_quantity" name="minimum_quantity" min="0" required>
                </div>

                <div class="form-group">
                    <label for="container_location">Container Location</label>
                    <input type="text" id="container_location" name="container_location" placeholder="e.g., A1">
                </div>

                <div class="form-group">
                    <label for="expiration_date">Expiration Date</label>
                    <input type="date" id="expiration_date" name="expiration_date">
                </div>
            </div>

            <div class="form-group">
                <label for="description">Description</label>
                <textarea id="description" name="description" rows="3" placeholder="Medication description and usage notes"></textarea>
            </div>

            <div class="form-group">
                <label for="pill_image">Pill Image (for recognition)</label>
                <input type="file" id="pill_image" name="pill_image" accept="image/*">
                <div id="imagePreview" class="file-preview"></div>
            </div>

            <button type="submit" class="btn btn-primary">‚ûï Add Medication</button>
        </form>
    </div>

    <div class="medication-list">
        <h2>All Medications</h2>
        <div class="medication-grid" id="medicationGrid">
            <!-- Will be populated by JavaScript -->
        </div>
    </div>
</div>
{% endblock %}

{% block extra_script %}
<script>
    let allMedications = [];

    // Search functionality
    const searchInput = document.getElementById('medicationSearch');
    let searchTimeout;

    searchInput.addEventListener('input', function() {
        clearTimeout(searchTimeout);
        
        searchTimeout = setTimeout(function() {
            const query = searchInput.value.toLowerCase().trim();
            filterMedications(query);
        }, 300);
    });

    function filterMedications(query) {
        const grid = document.getElementById('medicationGrid');
        
        if (!query) {
            // Show all
            renderMedications(allMedications);
            return;
        }
        
        const filtered = allMedications.filter(med => {
            return med.name.toLowerCase().includes(query) ||
                   (med.generic_name && med.generic_name.toLowerCase().includes(query)) ||
                   med.medication_type.toLowerCase().includes(query) ||
                   (med.container_location && med.container_location.toLowerCase().includes(query));
        });
        
        renderMedications(filtered);
    }

    function renderMedications(medications) {
        const grid = document.getElementById('medicationGrid');
        
        if (medications.length === 0) {
            grid.innerHTML = '<p style="color: rgba(255, 255, 255, 0.5); text-align: center;">No medications found.</p>';
            return;
        }
        
        grid.innerHTML = medications.map(med => {
            let stockClass = 'stock-good';
            let stockText = 'Normal';
            
            if (med.status === 'OUT') {
                stockClass = 'stock-out';
                stockText = 'Out of Stock';
            } else if (med.status === 'CRITICAL') {
                stockClass = 'stock-out';
                stockText = 'Critical';
            } else if (med.status === 'LOW') {
                stockClass = 'stock-low';
                stockText = 'Low Stock';
            }

            return `
                <div class="medication-card">
                    ${med.pill_image ? `<img src="${med.pill_image}" class="medication-photo" onerror="this.style.display='none'">` : ''}
                    <div class="medication-info">
                        <div class="medication-name">${med.name}</div>
                        ${med.generic_name ? `<div class="medication-type">${med.generic_name}</div>` : ''}
                        <div class="medication-details">
                            <div><strong>Type:</strong> ${med.medication_type_display || med.medication_type}</div>
                            <div><strong>Dosage:</strong> ${med.dosage}</div>
                            <div><strong>Stock:</strong> ${med.current_quantity} / ${med.minimum_quantity} units</div>
                            <div><strong>Location:</strong> ${med.container_location}</div>
                            ${med.expiration_date ? `<div><strong>Expires:</strong> ${med.expiration_date}</div>` : ''}
                        </div>
                        <span class="stock-status ${stockClass}">${stockText}</span>
                        <div class="card-actions">
                            <button class="btn btn-secondary" onclick="editMedication(${med.id})">Edit</button>
                            <button class="btn btn-secondary" onclick="updateImage(${med.id})">Update Image</button>
                            <button class="btn btn-secondary" onclick="deleteMedication(${med.id})">Delete</button>
                        </div>
                    </div>
                </div>
            `;
        }).join('');
    }

    // CSV Export
    function exportToCSV() {
        window.location.href = '{% url "medical_inventory:export_medications_csv" %}';
    }

    // Preview image before upload
    document.getElementById('pill_image').addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                const preview = document.getElementById('imagePreview');
                preview.innerHTML = `<img src="${e.target.result}" alt="Preview">`;
            };
            reader.readAsDataURL(file);
        }
    });

    // Submit form
    document.getElementById('medicationForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const formData = new FormData(this);
        
        try {
            const response = await fetch('/api/medications/add/', {
                method: 'POST',
                body: formData
            });

            const data = await response.json();

            if (data.success) {
                showAlert('‚úì Medication added successfully!', 'success');
                this.reset();
                document.getElementById('imagePreview').innerHTML = '';
                loadMedications();
            } else {
                showAlert('‚úó Error: ' + (data.message || 'Failed to add medication'), 'error');
            }
        } catch (error) {
            showAlert('‚úó Connection error: ' + error.message, 'error');
        }
    });

    // Load medications
    async function loadMedications() {
        try {
            const response = await fetch('/api/medications/list/');
            const data = await response.json();

            if (data.medications) {
                allMedications = data.medications;
                renderMedications(allMedications);
            }
        } catch (error) {
            console.error('Error loading medications:', error);
        }
    }

    function updateImage(medicationId) {
        const input = document.createElement('input');
        input.type = 'file';
        input.accept = 'image/*';
        input.onchange = async function(e) {
            const file = e.target.files[0];
            if (!file) return;

            const formData = new FormData();
            formData.append('image', file);
            formData.append('medication_id', medicationId);

            try {
                const response = await fetch('/api/medications/update-image/', {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();

                if (data.success) {
                    showAlert('‚úì Image updated successfully!', 'success');
                    loadMedications();
                } else {
                    showAlert('‚úó Error: ' + (data.message || 'Failed to update image'), 'error');
                }
            } catch (error) {
                showAlert('‚úó Connection error: ' + error.message, 'error');
            }
        };
        input.click();
    }

    function editMedication(medicationId) {
        window.location.href = `/inventory/${medicationId}/`;
    }

    async function deleteMedication(medicationId) {
        if (!confirm('Are you sure you want to delete this medication?')) return;

        try {
            const response = await fetch(`/api/medications/delete/${medicationId}/`, {
                method: 'DELETE',
                headers: {
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                }
            });

            const data = await response.json();

            if (data.success) {
                showAlert('‚úì Medication deleted successfully', 'success');
                loadMedications();
            } else {
                showAlert('‚úó Error: ' + (data.message || 'Failed to delete'), 'error');
            }
        } catch (error) {
            showAlert('‚úó Connection error: ' + error.message, 'error');
        }
    }

    function showAlert(message, type) {
        const alert = document.getElementById('alertBox');
        alert.textContent = message;
        alert.className = `alert ${type} show`;
        
        setTimeout(() => {
            alert.classList.remove('show');
        }, 5000);
    }

    // Load medications on page load
    loadMedications();
</script>
{% endblock %}
